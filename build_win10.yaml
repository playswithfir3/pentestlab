      datacenter: "{{ datacenter_name }}"
      folder: ""
      cluster: "{{ cluster_name }}"
      datastore: "datastore1"
      networks:
      - name: "192.168.100.0/24"
      customization:
        hostname: "{{ server_name }}"
      state: poweredoff
      wait_for_ip_address: no
    delegate_to: localhost

  - name: Connect Network
    vmware_guest_network:
      hostname: "{{ vcenter_server }}"
      username: "{{ vcenter_user }}"
      password: "{{ vcenter_pass }}"
      validate_certs: False
      name: "{{ server_name }}"
      datacenter: "{{ datacenter_name }}"
      networks:
      - name: "192.168.100.0/24"
        type: dhcp
        device_type: e1000
        state: present
        start_connected: yes
        connected: yes
    delegate_to: localhost

  - name: Start Virtual Machine
    vmware_guest:
      hostname: "{{ vcenter_server }}"
      username: "{{ vcenter_user }}"
      password: "{{ vcenter_pass }}"
      validate_certs: False
      name:  "{{ server_name }}"
      datacenter: "{{ datacenter_name }}"
      folder: ""
      cluster: "{{ cluster_name }}"
      datastore: "datastore1"
      customization:
        hostname: "{{ server_name }}"
      state: poweredon
      wait_for_ip_address: yes
    delegate_to: localhost
    register: find_output

  - debug:
      var: find_output.instance.ipv4

  - name: add host to hosts file
    lineinfile:
      path: /home/localadmin/production/hosts
      state: present
      insertafter: '^\[win\]'
      line: '{{ find_output.instance.ipv4 }}'
  - pause:
      minutes: 2
